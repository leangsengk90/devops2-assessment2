┌─────────────────────────────────────────────────────────────────────────────┐
│                        Internet / External Clients                           │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     │ HTTPS
                                     │
┌────────────────────────────────────▼────────────────────────────────────────┐
│                     AWS API Gateway (Shared - HTTP API)                      │
│              https://xxxxx.execute-api.us-east-1.amazonaws.com              │
│                                                                               │
│  Routes (Path-based routing + Path Rewriting):                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ANY /api1/{proxy+}      → Strip /api1 → Add Header → VPC Link     │    │
│  │  ANY /auth/{proxy+}      → Strip /auth → Add Header → VPC Link     │    │
│  │  ANY /profile/{proxy+}   → Strip /profile → Add Header → VPC Link  │    │
│  │  ANY /messenger/{proxy+} → Strip /messenger → Add Header → VPC Link│    │
│  │  ANY /finance/{proxy+}   → Strip /finance → Add Header → VPC Link  │    │
│  │  ANY /share/{proxy+}     → Strip /share → Add Header → VPC Link    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
│  Path Rewriting:                                                              │
│    /finance/api/hello  →  /api/hello  (+ X-Service-Name: devops2-g4-finance)│
│    /auth/             →  /            (+ X-Service-Name: devops2-g4-auth)   │
│                                                                               │
│  Stage: $default (auto-deploy)                                               │
│  CORS: Enabled (allow all origins)                                           │
│  Throttling: 5000 burst, 10000/sec rate                                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     │
┌────────────────────────────────────▼────────────────────────────────────────┐
│                          VPC Link (Shared)                                   │
│                   (Connects API Gateway to Private VPC)                      │
│                    Security Group: vpc-link-sg                               │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     │
    ┌────────────────────────────────┼────────────────────────────────┐
    │                          VPC (10.0.0.0/16)                       │
    │                                                                   │
    │  ┌────────────────────────────────────────────────────────────┐ │
    │  │              Private Subnets (Multiple AZs)                 │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │          SHARED APPLICATION LOAD BALANCER             │  │ │
    │  │  │  (Consolidated - Replaces 6 individual ALBs)          │  │ │
    │  │  │  ────────────────────────────────────────────────────  │  │ │
    │  │  │  HTTP Listener :80                                     │  │ │
    │  │  │                                                         │  │ │
    │  │  │  Listener Rules (Header-based routing):                │  │ │
    │  │  │  ┌─────────────────────────────────────────────────┐  │  │ │
    │  │  │  │ Priority 100: X-Service-Name = devops2-g4-api1  │  │  │ │
    │  │  │  │              → Forward to api1 Target Group     │  │  │ │
    │  │  │  ├─────────────────────────────────────────────────┤  │  │ │
    │  │  │  │ Priority 200: X-Service-Name = devops2-g4-auth  │  │  │ │
    │  │  │  │              → Forward to auth Target Group     │  │  │ │
    │  │  │  ├─────────────────────────────────────────────────┤  │  │ │
    │  │  │  │ Priority 300: X-Service-Name = devops2-g4-profile│ │  │ │
    │  │  │  │              → Forward to profile Target Group  │  │  │ │
    │  │  │  ├─────────────────────────────────────────────────┤  │  │ │
    │  │  │  │ Priority 400: X-Service-Name = devops2-g4-messenger│ │ │
    │  │  │  │              → Forward to messenger Target Group│  │  │ │
    │  │  │  ├─────────────────────────────────────────────────┤  │  │ │
    │  │  │  │ Priority 500: X-Service-Name = devops2-g4-finance│ │  │ │
    │  │  │  │              → Forward to finance Target Group  │  │  │ │
    │  │  │  ├─────────────────────────────────────────────────┤  │  │ │
    │  │  │  │ Priority 600: X-Service-Name = devops2-g4-share │  │  │ │
    │  │  │  │              → Forward to share Target Group    │  │  │ │
    │  │  │  └─────────────────────────────────────────────────┘  │  │ │
    │  │  │                                                         │  │ │
    │  │  │  Default Action: Return 404 (Service not found)        │  │ │
    │  │  │  Security Group: alb-sg (allow from vpc-link)          │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │ SERVICE: API1                                         │  │ │
    │  │  │ ────────────────────────────────────────────────────  │  │ │
    │  │  │ Target Group :80                                      │  │ │
    │  │  │        ↓                                              │  │ │
    │  │  │ ECS Cluster: devops2-g4-api1-cluster-prod            │  │ │
    │  │  │   ECS Service (Fargate): 2-10 tasks                  │  │ │
    │  │  │   Container: nginx:alpine :80                        │  │ │
    │  │  │   Auto-scale: CPU/Memory 30%-70%                     │  │ │
    │  │  │   Container Insights: Enabled                        │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │ SERVICE: AUTH                                         │  │ │
    │  │  │ ────────────────────────────────────────────────────  │  │ │
    │  │  │ Target Group :3000                                    │  │ │
    │  │  │        ↓                                              │  │ │
    │  │  │ ECS Cluster: devops2-g4-auth-cluster-prod            │  │ │
    │  │  │   ECS Service (Fargate): 2-10 tasks                  │  │ │
    │  │  │   Container: auth-app :3000                          │  │ │
    │  │  │   Auto-scale: CPU/Memory 30%-70%                     │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │ SERVICE: PROFILE                                      │  │ │
    │  │  │ ────────────────────────────────────────────────────  │  │ │
    │  │  │ Target Group :3001                                    │  │ │
    │  │  │        ↓                                              │  │ │
    │  │  │ ECS Cluster: devops2-g4-profile-cluster-prod         │  │ │
    │  │  │   ECS Service (Fargate): 2-10 tasks                  │  │ │
    │  │  │   Container: profile-app :3001                       │  │ │
    │  │  │   Auto-scale: CPU/Memory 30%-70%                     │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │ SERVICE: MESSENGER                                    │  │ │
    │  │  │ ────────────────────────────────────────────────────  │  │ │
    │  │  │ Target Group :3002                                    │  │ │
    │  │  │        ↓                                              │  │ │
    │  │  │ ECS Cluster: devops2-g4-messenger-cluster-prod       │  │ │
    │  │  │   ECS Service (Fargate): 2-10 tasks                  │  │ │
    │  │  │   Container: messenger-app :3002                     │  │ │
    │  │  │   Auto-scale: CPU/Memory 30%-70%                     │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │ SERVICE: FINANCE                                      │  │ │
    │  │  │ ────────────────────────────────────────────────────  │  │ │
    │  │  │ Target Group :8080                                    │  │ │
    │  │  │        ↓                                              │  │ │
    │  │  │ ECS Cluster: devops2-g4-finance-cluster-prod         │  │ │
    │  │  │   ECS Service (Fargate): 2-10 tasks                  │  │ │
    │  │  │   Container: finance-app :8080                       │  │ │
    │  │  │   Auto-scale: CPU/Memory 30%-70%                     │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  │  ┌──────────────────────────────────────────────────────┐  │ │
    │  │  │ SERVICE: SHARE                                        │  │ │
    │  │  │ ────────────────────────────────────────────────────  │  │ │
    │  │  │ Target Group :3004                                    │  │ │
    │  │  │        ↓                                              │  │ │
    │  │  │ ECS Cluster: devops2-g4-share-cluster-prod           │  │ │
    │  │  │   ECS Service (Fargate): 2-10 tasks                  │  │ │
    │  │  │   Container: share-app :3004                         │  │ │
    │  │  │   Auto-scale: CPU/Memory 30%-70%                     │  │ │
    │  │  └──────────────────────────────────────────────────────┘  │ │
    │  │                                                              │ │
    │  └──────────────────────────────────────────────────────────┘ │
    │                                                                 │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │              Public Subnets (Multiple AZs)                │ │
    │  │                                                            │ │
    │  │  NAT Gateway (provides internet access for containers)    │ │
    │  │              ↓                                             │ │
    │  │       Internet Gateway                                     │ │
    │  └──────────────────────────────────────────────────────────┘ │
    └───────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                        Supporting Infrastructure                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ECR Repositories (us-east-1):                                          │
│  ├─ 481604401489.dkr.ecr.us-east-1.amazonaws.com/devops2-g4-api1-prod  │
│  ├─ 481604401489.dkr.ecr.us-east-1.amazonaws.com/devops2-g4-auth-prod  │
│  ├─ 481604401489.dkr.ecr.us-east-1.amazonaws.com/devops2-g4-profile-prod│
│  ├─ 481604401489.dkr.ecr.us-east-1.amazonaws.com/devops2-g4-messenger-prod│
│  ├─ 481604401489.dkr.ecr.us-east-1.amazonaws.com/devops2-g4-finance-prod│
│  └─ 481604401489.dkr.ecr.us-east-1.amazonaws.com/devops2-g4-share-prod │
│      └─ Image scanning: Amazon Inspector (enabled)                     │
│                                                                          │
│  IAM Roles:                                                             │
│  ├─ ECS Task Execution Role (pull ECR images, write CloudWatch logs)   │
│  └─ ECS Task Role (application-level AWS permissions)                  │
│                                                                          │
│  CloudWatch:                                                            │
│  ├─ Log Groups:                                                         │
│  │  ├─ /aws/ecs/devops2-g4-app (shared ECS logs)                       │
│  │  ├─ /aws/apigateway/devops2-g4-main-prod (API Gateway logs)         │
│  │  └─ /aws/ecs/containerinsights/{cluster}/performance (per cluster)  │
│  │                                                                       │
│  └─ Alarms (per service):                                               │
│     ├─ CPU High (>70%) → Scale Up                                       │
│     ├─ CPU Low (<30%) → Scale Down                                      │
│     ├─ Memory High (>70%) → Scale Up                                    │
│     └─ Memory Low (<30%) → Scale Down                                   │
│                                                                          │
│  Security Groups:                                                       │
│  ├─ ALB Security Group: Allow traffic from VPC Link                    │
│  ├─ ECS Security Group: Allow traffic from ALB only                    │
│  └─ VPC Link Security Group: Allow HTTPS from anywhere                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘


Traffic Flow Example:
═══════════════════════════════════════════════════════════════════════════

Client Request:
  GET https://xxxxx.execute-api.us-east-1.amazonaws.com/finance/api/hello

       ↓
   API Gateway (receives /finance/api/hello)
       ↓ (strips /finance prefix → /api/hello)
       ↓ (adds header: X-Service-Name: devops2-g4-finance)
   VPC Link
       ↓
   Shared ALB (receives /api/hello + header)
       ↓ (matches header → routes to finance target group)
   Finance Target Group :8080
       ↓
   Finance ECS Task (Container) :8080 (receives /api/hello)
       ↓
   Response returned through same path


Key Features:
═════════════════════════════════════════════════════════════════════════
✓ Single API Gateway with 6 service routes
✓ Path-based routing + path rewriting (/api1, /auth, /profile, /messenger, /finance, /share)
✓ SINGLE SHARED ALB (replaces 6 individual ALBs) - saves $352/month (79% cost reduction)
✓ Header-based routing at ALB level (X-Service-Name header)
✓ Each service isolated with its own target group, ECS cluster, and containers
✓ Services can use different container ports (80, 3000, 3001, 3002, 8080, 3004)
✓ Auto-scaling: 2-10 tasks per service based on CPU/Memory
✓ Container Insights enabled for monitoring
✓ Private ALB (not internet-facing)
✓ NAT Gateway for container internet access (pull images, external APIs)
✓ ECR image scanning with Amazon Inspector
✓ Centralized logging in CloudWatch
✓ High availability across multiple availability zones

Cost Optimization:
═════════════════════════════════════════════════════════════════════════
• Consolidated 6 ALBs → 1 Shared ALB
• Before: 6 × $74.83/month = $448.95/month
• After: 1 × $96.43/month = $96.43/month
• Savings: $352.52/month (79% reduction in ALB costs)